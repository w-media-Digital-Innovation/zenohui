name: Release

on:
  release:
    types: [created]

jobs:
  # Build for macOS (Intel + Apple Silicon)
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    strategy:
      matrix:
        target:
          - x86_64-apple-darwin
          - aarch64-apple-darwin
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Build
        run: cargo build --release --target ${{ matrix.target }}
      
      - name: Create tarball
        run: |
          cd target/${{ matrix.target }}/release
          tar czf zenohui-${{ github.ref_name }}-${{ matrix.target }}.tar.gz zenohui
          mv zenohui-${{ github.ref_name }}-${{ matrix.target }}.tar.gz ../../../
      
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./zenohui-${{ github.ref_name }}-${{ matrix.target }}.tar.gz
          asset_name: zenohui-${{ github.ref_name }}-${{ matrix.target }}.tar.gz
          asset_content_type: application/gzip

  # Build for Windows
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    strategy:
      matrix:
        target:
          - x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Build
        run: cargo build --release --target ${{ matrix.target }}
      
      - name: Create zip
        run: |
          cd target/${{ matrix.target }}/release
          7z a zenohui-${{ github.ref_name }}-${{ matrix.target }}.zip zenohui.exe
          move zenohui-${{ github.ref_name }}-${{ matrix.target }}.zip ../../../
      
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./zenohui-${{ github.ref_name }}-${{ matrix.target }}.zip
          asset_name: zenohui-${{ github.ref_name }}-${{ matrix.target }}.zip
          asset_content_type: application/zip

  # Build Linux tarballs for various architectures
  build-linux-tarballs:
    name: Build Linux Tarballs
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
          - armv7-unknown-linux-gnueabihf
          - arm-unknown-linux-gnueabihf
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf
      
      - name: Build
        run: |
          cargo install cross --git https://github.com/cross-rs/cross
          cross build --release --target ${{ matrix.target }}
      
      - name: Create tarball
        run: |
          cd target/${{ matrix.target }}/release
          tar czf zenohui-${{ github.ref_name }}-${{ matrix.target }}.tar.gz zenohui
          mv zenohui-${{ github.ref_name }}-${{ matrix.target }}.tar.gz ../../../
      
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./zenohui-${{ github.ref_name }}-${{ matrix.target }}.tar.gz
          asset_name: zenohui-${{ github.ref_name }}-${{ matrix.target }}.tar.gz
          asset_content_type: application/gzip

  # Build .deb packages for Debian/Ubuntu
  build-deb:
    name: Build .deb packages
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
          - armv7-unknown-linux-gnueabihf
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Install cargo-deb
        run: cargo install cargo-deb
      
      - name: Install cross for non-x86_64 targets
        if: matrix.target != 'x86_64-unknown-linux-gnu'
        run: cargo install cross --git https://github.com/cross-rs/cross
      
      - name: Build binary (x86_64)
        if: matrix.target == 'x86_64-unknown-linux-gnu'
        run: cargo build --release --target ${{ matrix.target }}
      
      - name: Build binary (cross-compilation)
        if: matrix.target != 'x86_64-unknown-linux-gnu'
        run: cross build --release --target ${{ matrix.target }}
      
      - name: Build .deb package
        run: cargo deb --no-build --target ${{ matrix.target }}
      
      - name: Find and rename .deb file
        id: find_deb
        run: |
          DEB_FILE=$(ls target/${{ matrix.target }}/debian/*.deb)
          echo "deb_file=$DEB_FILE" >> $GITHUB_OUTPUT
      
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ${{ steps.find_deb.outputs.deb_file }}
          asset_name: ${{ github.event.repository.name }}_${{ github.ref_name }}_${{ matrix.target }}.deb
          asset_content_type: application/vnd.debian.binary-package

  # Build .rpm packages for RedHat/Fedora/CentOS
  build-rpm:
    name: Build .rpm packages
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Install cargo-generate-rpm
        run: cargo install cargo-generate-rpm
      
      - name: Install cross for non-x86_64 targets
        if: matrix.target != 'x86_64-unknown-linux-gnu'
        run: cargo install cross --git https://github.com/cross-rs/cross
      
      - name: Build binary (x86_64)
        if: matrix.target == 'x86_64-unknown-linux-gnu'
        run: cargo build --release --target ${{ matrix.target }}
      
      - name: Build binary (cross-compilation)
        if: matrix.target != 'x86_64-unknown-linux-gnu'
        run: cross build --release --target ${{ matrix.target }}
      
      - name: Generate completions and manpages
        if: matrix.target == 'x86_64-unknown-linux-gnu'
        run: cargo run --release -- --version  # Trigger build.rs to generate files
      
      - name: Build .rpm package
        run: cargo generate-rpm --target ${{ matrix.target }}
      
      - name: Find and rename .rpm file
        id: find_rpm
        run: |
          RPM_FILE=$(ls target/${{ matrix.target }}/generate-rpm/*.rpm)
          echo "rpm_file=$RPM_FILE" >> $GITHUB_OUTPUT
      
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ${{ steps.find_rpm.outputs.rpm_file }}
          asset_name: ${{ github.event.repository.name }}-${{ github.ref_name }}-${{ matrix.target }}.rpm
          asset_content_type: application/x-rpm
